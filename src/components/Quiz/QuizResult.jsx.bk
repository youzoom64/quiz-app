import React, { useRef, useState } from 'react';
import { Card, CardHeader, CardContent } from '../ui/card';
import { Button } from '../ui/button';
import html2canvas from 'html2canvas';

const QuizResult = function QuizResult({ score, total, wrongQuestions, onRetry }) {
  const resultCardRef = useRef(null);
  const [isSharing, setIsSharing] = useState(false);

  const uploadImage = async (blob) => {
    try {
      const formData = new FormData();
      formData.append('image', blob, 'result.png');

      const response = await fetch('upload.php', {  // PHPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®URL
        method: 'POST',
        body: formData
      });

      if (!response.ok) throw new Error('Upload failed');

      const data = await response.json();
      return `https://blueferret.mbsrv.net/quiz-images/${data.filename}`;  // å®Ÿéš›ã®URLãƒ‘ã‚¹ã«ä¿®æ­£
    } catch (error) {
      console.error('Upload error:', error);
      throw error;
    }
  };

  const handleShareToTwitter = async () => {
    try {
      setIsSharing(true);
      console.log('ã‚·ã‚§ã‚¢å‡¦ç†é–‹å§‹');

      // çµæœè¡¨ç¤ºéƒ¨åˆ†ã®ã‚­ãƒ£ãƒ—ãƒãƒ£
      const resultElement = resultCardRef.current.querySelector('.result-content');
      const canvas = await html2canvas(resultElement, {
        backgroundColor: '#ffffff',
        scale: 2,
        logging: true,
        useCORS: true,
        allowTaint: true
      });

      // Canvas ã‚’ Blob ã«å¤‰æ›
      const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, 'image/png', 0.9);
      });

      // ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const imageUrl = await uploadImage(blob);
      console.log('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', imageUrl);

      // ãƒ¡ã‚¿ã‚¿ã‚°ã‚’æ›´æ–°
      document.querySelectorAll('meta[name^="twitter:"]').forEach(el => el.remove());
      const metaTags = [
        { name: 'twitter:card', content: 'summary_large_image' },
        { name: 'twitter:title', content: 'ç§‘å­¦çŸ¥è­˜ãƒ†ã‚¹ãƒˆçµæœ' },
        { name: 'twitter:description', content: `${total}ç‚¹ä¸­${score}ç‚¹ã§ã—ãŸï¼` },
        { name: 'twitter:image', content: imageUrl }
      ];

      metaTags.forEach(({ name, content }) => {
        const meta = document.createElement('meta');
        meta.name = name;
        meta.content = content;
        document.head.appendChild(meta);
      });

      const wrongQuestionsText = wrongQuestions.length > 0 
        ? `\n\né–“é•ãˆãŸå•é¡Œï¼š${wrongQuestions.join(', ')}ç•ª` 
        : '\n\nå…¨å•æ­£è§£ï¼ğŸ‰';

      const shareText = `ç§‘å­¦çŸ¥è­˜ãƒ†ã‚¹ãƒˆã§${total}ç‚¹ä¸­${score}ç‚¹ã§ã—ãŸï¼${wrongQuestionsText}`;
      const appUrl = 'https://blueferret.mbsrv.net/quiz-app/';

      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(appUrl)}`;
      window.open(twitterUrl, '_blank');

    } catch (error) {
      console.error('ã‚·ã‚§ã‚¢ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚·ã‚§ã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
      setIsSharing(false);
    }
  };

  return (
    <Card className="max-w-2xl mx-auto">
      <CardHeader>
        <h2 className="text-2xl font-bold text-center">ãƒ†ã‚¹ãƒˆçµæœ</h2>
      </CardHeader>
      <CardContent>
        <div ref={resultCardRef}>
          <div className="result-content space-y-6 bg-white p-6 rounded-lg">
            <div className="text-center">
              <h3 className="text-xl mb-4">ã‚ãªãŸã®ç§‘å­¦çŸ¥è­˜ãƒ†ã‚¹ãƒˆã®çµæœã¯...</h3>
              <p className="text-4xl font-bold mb-2">
                {score} / {total}ç‚¹
              </p>
              <p className="text-lg text-gray-600">
                æ­£ç­”ç‡: {Math.round((score / total) * 100)}%
              </p>
            </div>

            {wrongQuestions.length > 0 && (
              <div className="border-t border-b py-4">
                <p className="font-semibold mb-2">é–“é•ãˆãŸå•é¡Œ</p>
                <p className="text-red-600">
                  {wrongQuestions.join(', ')}ç•ª
                </p>
              </div>
            )}
          </div>

          <div className="share-buttons flex flex-col gap-4 items-center pt-4">
            <Button
              onClick={handleShareToTwitter}
              disabled={isSharing}
              className="bg-blue-500 hover:bg-blue-600 w-full max-w-xs"
            >
              {isSharing ? 'ã‚·ã‚§ã‚¢ä¸­...' : 'çµæœã‚’Xã§ã‚·ã‚§ã‚¢'}
            </Button>
            <Button
              onClick={onRetry}
              variant="outline"
              className="w-full max-w-xs"
            >
              ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default QuizResult;